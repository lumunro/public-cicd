# Comment Here
name: CI + CD Environments

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

anchors:
  download_artifacts: &download_artifacts
    name: Download Artifacts
    uses: actions/download-artifact@v2
    with:
      name: cicd-environments
      path: iac/
  
  deploy: &deploy
    name: Deploy
    run: |
      echo I am deploying in ${{ env.CURRENT_ENVIRONMENT }}
      echo using template file ${{ env.TEMPLATE_FILE }}
      echo using parameter file ${{ env.PARAMETERS_FILE }}
      echo contents of parameters file as follows:
      cat ${{ env.PARAMETERS_FILE }}


jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Build
        run: echo Hello, world

      - name: Upload Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: cicd-environments
          if-no-files-found: error
          path: iac/
  
  DeployDevelopment:
    name: Deploy to Development
    environment: Development
    if: github.event_name == 'pull_request'
    needs: [Build]
    runs-on: ubuntu-latest
    env:
      CURRENT_ENVIRONMENT: Development
      TEMPLATE_FILE: ./iac/main.bicep
      PARAMETERS_FILE: ./iac/parameters.development.json
    steps:
      - *download_artifacts
      - *deploy

        # Log into Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

        # Pre Deployment Tasks
      - name: Pre Deployment Tasks
        run: |
          echo "DATETIME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

        # Deploy Bicep Template
      - name: Deploy Bicep Template
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_CREDENTIALS.subscriptionId }}
          deploymentName: ghactions-bicep-deploy-${{ env.DATETIME }}
          scope: resourcegroup
          resourceGroupName: ${{ secrets.RESOURCE_GROUP_NAME }}
          template: ${{ env.TEMPLATE_FILE }}
          parameters: ${{ env.PARAMETERS_FILE }}
  
  DeployStaging:
    name: Deploy to Staging
    environment: Staging
    if: github.event.ref == 'refs/heads/main'
    needs: [Build]
    runs-on: ubuntu-latest
    env:
      CURRENT_ENVIRONMENT: Staging
      TEMPLATE_FILE: ./iac/main.bicep
      PARAMETERS_FILE: ./iac/parameters.staging.json
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          name: cicd-environments
          path: iac/
      
      - name: Deploy
        run: |
          echo I am deploying in ${{ env.CURRENT_ENVIRONMENT }}
          echo using template file ${{ env.TEMPLATE_FILE }}
          echo using parameter file ${{ env.PARAMETERS_FILE }}
          echo contents of parameters file as follows:
          cat ${{ env.PARAMETERS_FILE }}

      # Log into Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

        # Pre Deployment Tasks
      - name: Pre Deployment Tasks
        run: |
          echo "DATETIME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

        # Deploy Bicep Template
      - name: Deploy Bicep Template
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_CREDENTIALS.subscriptionId }}
          deploymentName: ghactions-bicep-deploy-${{ env.DATETIME }}
          scope: resourcegroup
          resourceGroupName: ${{ secrets.RESOURCE_GROUP_NAME }}
          template: ${{ env.TEMPLATE_FILE }}
          parameters: ${{ env.PARAMETERS_FILE }}
  
  DeployProduction:
    name: Deploy to Production
    environment: Production
    needs: [DeployStaging]
    runs-on: ubuntu-latest
    env:
      CURRENT_ENVIRONMENT: Production
      TEMPLATE_FILE: ./iac/main.bicep
      PARAMETERS_FILE: ./iac/parameters.production.json
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          name: cicd-environments
          path: iac/
      
      - name: Deploy
        run: |
          echo I am deploying in ${{ env.CURRENT_ENVIRONMENT }}
          echo using template file ${{ env.TEMPLATE_FILE }}
          echo using parameter file ${{ env.PARAMETERS_FILE }}
          echo contents of parameters file as follows:
          cat ${{ env.PARAMETERS_FILE }}
      
      # Log into Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

        # Pre Deployment Tasks
      - name: Pre Deployment Tasks
        run: |
          echo "DATETIME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

        # Deploy Bicep Template
      - name: Deploy Bicep Template
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_CREDENTIALS.subscriptionId }}
          deploymentName: ghactions-bicep-deploy-${{ env.DATETIME }}
          scope: resourcegroup
          resourceGroupName: ${{ secrets.RESOURCE_GROUP_NAME }}
          template: ${{ env.TEMPLATE_FILE }}
          parameters: ${{ env.PARAMETERS_FILE }}
